from collections import defaultdict
import csv
import sys
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit

timing = [
    (14, 34.837),
    (14, 34.517),
    (14, 34.473),
    (14, 34.73),
    (14, 34.419),
    (1, 408.259),
    (1, 406.325),
    (1, 406.265),
    (1, 407.545),
    (1, 406.01),
    (8, 60.804),
    (8, 60.761),
    (8, 60.778),
    (8, 60.61),
    (8, 60.734),
    (12, 40.582),
    (12, 40.217),
    (12, 40.204),
    (12, 40.442),
    (12, 40.152),
    (2, 208.765),
    (2, 205.781),
    (2, 205.556),
    (2, 209.875),
    (2, 204.74099999999999),
    (7, 68.049),
    (7, 68.544),
    (7, 68.72),
    (7, 67.283),
    (7, 68.432),
    (18, 27.216),
    (18, 27.596),
    (18, 27.685),
    (18, 27.634),
    (18, 27.666),
    (11, 44.778),
    (11, 45.381),
    (11, 44.773),
    (11, 44.745),
    (11, 44.828),
    (22, 22.661),
    (22, 22.963),
    (22, 22.556),
    (22, 23.137),
    (22, 22.817),
    (20, 24.913),
    (20, 24.696),
    (20, 24.556),
    (20, 24.847),
    (20, 24.74),
    (23, 21.525),
    (23, 21.603),
    (23, 21.727),
    (23, 21.475),
    (23, 21.73),
    (21, 23.846),
    (21, 23.646),
    (21, 23.409),
    (21, 23.633),
    (21, 23.883),
    (16, 31.303),
    (16, 31.252),
    (16, 31.188),
    (16, 30.971),
    (16, 31.061),
    (3, 145.459),
    (3, 149.564),
    (3, 146.289),
    (3, 146.522),
    (3, 147.722),
    (24, 20.679),
    (24, 20.591),
    (24, 20.531),
    (24, 20.703),
    (24, 20.72),
    (4, 115.191),
    (4, 111.80799999999999),
    (4, 114.021),
    (4, 114.032),
    (4, 113.18),
    (15, 33.078),
    (15, 34.159),
    (15, 33.007),
    (15, 34.144),
    (15, 33.373),
    (6, 79.98),
    (6, 80.497),
    (6, 80.607),
    (6, 79.774),
    (6, 76.36),
    (13, 37.904),
    (13, 37.509),
    (13, 37.62),
    (13, 37.94),
    (13, 38.573),
    (19, 26.29),
    (19, 25.87),
    (19, 25.746),
    (19, 26.557),
    (19, 26.027),
    (10, 48.932),
    (10, 48.74),
    (10, 48.565),
    (10, 49.154),
    (10, 49.529),
    (5, 94.571),
    (5, 94.595),
    (5, 94.402),
    (5, 94.037),
    (5, 93.932),
    (9, 54.021),
    (9, 53.55),
    (9, 53.452),
    (9, 53.692),
    (9, 53.674),
    (17, 29.215),
    (17, 28.862),
    (17, 28.697),
    (17, 28.719),
    (17, 28.759),
    (179, 32.408),
    (64, 29.745),
    (134, 31.613),
    (199, 32.545),
    (39, 26.435),
    (34, 29.229),
    (124, 31.783),
    (189, 32.511),
    (184, 32.46),
    (139, 31.723),
    (44, 26.356),
    (174, 31.993),
    (144, 31.14),
    (94, 29.659),
    (104, 30.844),
    (69, 29.439),
    (129, 31.295),
    (24, 21.022),
    (89, 30.411),
    (149, 32.08),
    (74, 29.202),
    (169, 32.268),
    (84, 29.834),
    (114, 31.567),
    (29, 33.818),
    (164, 31.865),
    (159, 32.019),
    (54, 28.753),
    (49, 30.351),
    (154, 31.639),
    (99, 30.316),
    (194, 32.37),
    (79, 29.356),
    (109, 31.06),
    (119, 31.56),
    (59, 29.269),
]

# timing = [
#     (1, 290.894),
#     (2, 272.826),
#     (2, 269.556),
#     (2, 273.233),
#     (2, 266.801),
#     (2, 270.397),
#     (4, 141.941),
#     (4, 140.973),
#     (4, 138.99),
#     (4, 134.222),
#     (4, 139.685),
#     (6, 104.071),
#     (6, 104.09),
#     (6, 102.132),
#     (6, 104.262),
#     (6, 104.14500000000001),
#     (8, 77.89099999999999),
#     (8, 78.538),
#     (8, 79.176),
#     (8, 79.116),
#     (8, 76.55799999999999),
#     (10, 63.565),
#     (10, 62.552),
#     (10, 62.88),
#     (10, 62.724000000000004),
#     (10, 62.991),
#     (12, 53.3),
#     (12, 52.94),
#     (12, 52.831),
#     (12, 52.584),
#     (12, 52.341),
#     (14, 46.592),
#     (14, 46.5),
#     (14, 46.669),
#     (14, 45.791),
#     (14, 46.492),
#     (16, 40.938),
#     (16, 40.805),
#     (16, 40.384),
#     (16, 40.731),
#     (16, 41.26),
#     (18, 36.102),
#     (18, 36.534),
#     (18, 36.528),
#     (18, 35.72),
#     (18, 36.803),
#     (20, 33.029),
#     (20, 32.262),
#     (20, 32.374),
#     (20, 32.421),
#     (20, 32.431),
#     (22, 29.386),
#     (22, 29.819),
#     (22, 29.839),
#     (22, 29.717),
#     (22, 29.974),
#     (24, 26.977),
#     (24, 26.836),
#     (24, 26.883),
#     (24, 26.947),
#     (24, 26.893),
#     (26, 51.2),
#     (26, 51.394),
#     (26, 51.323),
#     (26, 50.978),
#     (26, 51.678),
#     (28, 49.014),
#     (28, 49.339),
#     (28, 49.178),
#     (28, 49.54),
#     (28, 49.218),
#     (30, 47.212),
#     (30, 46.932),
#     (30, 47.47),
#     (30, 47.329),
#     (30, 47.236),
#     (32, 45.536),
#     (32, 45.704),
#     (32, 45.547),
#     (32, 45.563),
#     (32, 45.777),
#     (34, 43.357),
#     (34, 44.012),
#     (34, 43.381),
#     (34, 43.497),
#     (34, 43.523),
#     (36, 42.432),
#     (36, 42.355),
#     (36, 42.449),
#     (36, 42.673),
#     (36, 42.443),
#     (38, 42.339),
#     (38, 42.589),
#     (38, 42.418),
#     (38, 41.936),
#     (38, 42.149),
#     (40, 42.128),
#     (40, 42.243),
#     (40, 42.336),
#     (40, 42.269),
#     (40, 41.516),
#     (42, 41.925),
#     (42, 42.269),
#     (42, 42.276),
#     (42, 41.908),
#     (42, 42.684),
#     (44, 43.801),
#     (44, 42.645),
#     (44, 42.626),
#     (44, 42.62),
#     (44, 42.499),
#     (46, 43.714),
#     (46, 43.491),
#     (46, 43.834),
#     (46, 44.186),
#     (46, 44.616),
#     (48, 44.027),
#     (48, 43.989),
#     (48, 43.992),
#     (48, 43.927),
#     (48, 44.056),
#     (50, 43.952),
#     (50, 43.907),
#     (50, 44.041),
#     (50, 43.981),
#     (50, 44.091),
#     (52, 44.003),
#     (52, 43.805),
#     (52, 44.145),
#     (52, 44.162),
#     (52, 43.978),
#     (54, 45.796),
#     (54, 45.112),
#     (54, 45.045),
#     (54, 45.028),
#     (54, 44.952),
#     (56, 45.639),
#     (56, 45.384),
#     (56, 45.529),
#     (56, 45.516),
#     (56, 45.64),
#     (58, 45.078),
#     (58, 45.1),
#     (58, 45.164),
#     (58, 45.073),
#     (58, 45.112),
#     (60, 45.658),
#     (60, 45.368),
#     (60, 45.131),
#     (60, 45.306),
#     (60, 45.17),
#     (62, 44.663),
#     (62, 44.61),
#     (62, 44.648),
#     (62, 44.718),
#     (62, 44.751),
# ]


def avg(x):
    return sum(x) / len(x)


def main():
    infos = {}
    info = {}

    for u, t in timing:
        if u not in infos:
            infos[u] = []
        infos[u].append(t)

    for u, v in infos.items():
        info[u] = sum(v) / len(v)

    speedup = {}
    for k in info:
        speedup[k] = info[1] / info[k]

    xdata = np.array(sorted(speedup.keys()))
    ydata = np.array([speedup[k] for k in xdata])

    # xdata = np.array(sorted(info.keys()))
    # ydata = np.array([info[k] for k in xdata])

    # def amdahl(p, f):
    #     return info[1] * f + (1 - f) * info[1] / p

    def amdahl(p, f):
        return 1 / (f + (1 - f) / p)

    my_dpi = 96
    plt.figure(figsize=(1000/my_dpi, 400/my_dpi), dpi=my_dpi)

    [f], _ = curve_fit(amdahl, xdata, ydata)
    plt.subplot(1, 2, 1)
    plt.scatter(xdata, ydata, c='k', label='data', marker='+')
    plt.plot(xdata, amdahl(xdata, f), 'k+-',
             alpha=0.3, label='fit: f=%5.3f' % f)
    plt.grid()
    plt.title('Strong Scaling')
    plt.xlabel('cores')
    plt.ylabel('speedup')
    plt.xscale('log')
    plt.yscale('log')
    plt.legend()

    file = sys.argv[1]
    r = csv.reader(open(file))

    serial = defaultdict(list)
    parallel = defaultdict(list)

    mode = serial

    for line in r:
        if line == ['serial']:
            mode = serial
        elif line == ['parallel']:
            mode = parallel
        else:
            nproc, time = line
            mins, secs = time.split('m')
            secs = secs.rstrip('s')
            total = int(mins) * 60 + float(secs)
            # if int(nproc) > 24:
            #     continue
            mode[int(nproc)].append(total)

    s = {k: avg(v) for k, v in serial.items()}
    p = {k: avg(v) for k, v in parallel.items()}

    speedup = {}
    for k in s:
        speedup[k] = s[k] / p[k]

    xdata = np.array(sorted(speedup.keys()))
    ydata = np.array([speedup[k] for k in xdata])

    def gustafson(p, f):
        return f + (1 - f) * p

    [f], _ = curve_fit(gustafson, xdata, ydata)

    plt.subplot(1, 2, 2)
    plt.scatter(xdata, ydata, c='k', marker='+', label='data')
    plt.plot(xdata, gustafson(xdata, f), 'k+-', label='fit: f=%5.3f' % f, alpha=0.3)
    plt.grid()
    plt.title('Weak Scaling')
    plt.xlabel('cores')
    plt.ylabel('scaled speedup')
    plt.xscale('log')
    plt.yscale('log')
    plt.legend()

    plt.savefig('speedups-more.png', dpi=my_dpi * 2)


if __name__ == '__main__':
    main()
