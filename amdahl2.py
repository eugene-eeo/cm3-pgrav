import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit

timing = [
    (1, 290.894),
    (2, 272.826),
    (2, 269.556),
    (2, 273.233),
    (2, 266.801),
    (2, 270.397),
    (4, 141.941),
    (4, 140.973),
    (4, 138.99),
    (4, 134.222),
    (4, 139.685),
    (6, 104.071),
    (6, 104.09),
    (6, 102.132),
    (6, 104.262),
    (6, 104.14500000000001),
    (8, 77.89099999999999),
    (8, 78.538),
    (8, 79.176),
    (8, 79.116),
    (8, 76.55799999999999),
    (10, 63.565),
    (10, 62.552),
    (10, 62.88),
    (10, 62.724000000000004),
    (10, 62.991),
    (12, 53.3),
    (12, 52.94),
    (12, 52.831),
    (12, 52.584),
    (12, 52.341),
    (14, 46.592),
    (14, 46.5),
    (14, 46.669),
    (14, 45.791),
    (14, 46.492),
    (16, 40.938),
    (16, 40.805),
    (16, 40.384),
    (16, 40.731),
    (16, 41.26),
    (18, 36.102),
    (18, 36.534),
    (18, 36.528),
    (18, 35.72),
    (18, 36.803),
    (20, 33.029),
    (20, 32.262),
    (20, 32.374),
    (20, 32.421),
    (20, 32.431),
    (22, 29.386),
    (22, 29.819),
    (22, 29.839),
    (22, 29.717),
    (22, 29.974),
    (24, 26.977),
    (24, 26.836),
    (24, 26.883),
    (24, 26.947),
    (24, 26.893),
    (26, 51.2),
    (26, 51.394),
    (26, 51.323),
    (26, 50.978),
    (26, 51.678),
    (28, 49.014),
    (28, 49.339),
    (28, 49.178),
    (28, 49.54),
    (28, 49.218),
    (30, 47.212),
    (30, 46.932),
    (30, 47.47),
    (30, 47.329),
    (30, 47.236),
    (32, 45.536),
    (32, 45.704),
    (32, 45.547),
    (32, 45.563),
    (32, 45.777),
    (34, 43.357),
    (34, 44.012),
    (34, 43.381),
    (34, 43.497),
    (34, 43.523),
    (36, 42.432),
    (36, 42.355),
    (36, 42.449),
    (36, 42.673),
    (36, 42.443),
    (38, 42.339),
    (38, 42.589),
    (38, 42.418),
    (38, 41.936),
    (38, 42.149),
    (40, 42.128),
    (40, 42.243),
    (40, 42.336),
    (40, 42.269),
    (40, 41.516),
    (42, 41.925),
    (42, 42.269),
    (42, 42.276),
    (42, 41.908),
    (42, 42.684),
    (44, 43.801),
    (44, 42.645),
    (44, 42.626),
    (44, 42.62),
    (44, 42.499),
    (46, 43.714),
    (46, 43.491),
    (46, 43.834),
    (46, 44.186),
    (46, 44.616),
    (48, 44.027),
    (48, 43.989),
    (48, 43.992),
    (48, 43.927),
    (48, 44.056),
    (50, 43.952),
    (50, 43.907),
    (50, 44.041),
    (50, 43.981),
    (50, 44.091),
    (52, 44.003),
    (52, 43.805),
    (52, 44.145),
    (52, 44.162),
    (52, 43.978),
    (54, 45.796),
    (54, 45.112),
    (54, 45.045),
    (54, 45.028),
    (54, 44.952),
    (56, 45.639),
    (56, 45.384),
    (56, 45.529),
    (56, 45.516),
    (56, 45.64),
    (58, 45.078),
    (58, 45.1),
    (58, 45.164),
    (58, 45.073),
    (58, 45.112),
    (60, 45.658),
    (60, 45.368),
    (60, 45.131),
    (60, 45.306),
    (60, 45.17),
    (62, 44.663),
    (62, 44.61),
    (62, 44.648),
    (62, 44.718),
    (62, 44.751),
]


def main():
    infos = {}
    info = {}

    for u, t in timing:
        if u not in infos:
            infos[u] = []
        infos[u].append(t)

    for u, v in infos.items():
        info[u] = sum(v) / len(v)

    speedup = {}
    for k in info:
        speedup[k] = info[1] / info[k]

    xdata = np.array(sorted(speedup.keys()))
    ydata = np.array([speedup[k] for k in xdata])

    # xdata = np.array(sorted(info.keys()))
    # ydata = np.array([info[k] for k in xdata])

    # def amdahl(p, f):
    #     return info[1] * f + (1 - f) * info[1] / p

    def amdahl(p, f):
        return 1 / (f + (1 - f) / p)

    [f], _ = curve_fit(amdahl, xdata, ydata)
    plt.scatter(xdata, ydata, c='b', label='data')
    plt.scatter(xdata, amdahl(xdata, f), c='r', label='fit: f=%5.3f' % f)
    plt.grid()
    plt.xlabel('cores')
    plt.ylabel('speedup')
    plt.legend()
    plt.show()


if __name__ == '__main__':
    main()
